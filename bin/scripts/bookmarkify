#!/usr/bin/env ruby

require 'pathname'
require 'time'
require 'fileutils'
require 'tempfile'

DEBUG_MODE = !!ENV["DEBUG"]


# TODO Use tags, for tags

DATE_FORMAT = "%Y-%m-%d"

path_in_arg = ARGV[0]
if File.directory?(File.expand_path(path_in_arg))
  puts "Directory given, looking for newest bookmark"
  all_bookmark_files = Dir.glob(File.join(File.expand_path(path_in_arg), "/bookmark_*.html"))
  newest_bookmark_file = all_bookmark_files.sort_by {|f| File.mtime(f) }.last
  path = Pathname.new(File.expand_path(newest_bookmark_file))
else
  path = Pathname.new(File.expand_path(ARGV[0]))
end

puts "Processing file '#{path}'"

def get_attribute(lines, attr, null_value: nil)
  line_with_attr = lines.find {|l| l.start_with?("#{attr}:") }
  attr_value = line_with_attr.sub("#{attr}:", "").strip
  if null_value && null_value == attr_value
    nil
  else
    attr_value
  end
end

top_lines = File.readlines(path)[0..30]

attrs = {
  title: get_attribute(top_lines, "TITLE"),
  url: get_attribute(top_lines, "URL"),
  date: Time.parse(get_attribute(top_lines, "DATE")),
  lang: get_attribute(top_lines, "LANGUAGE"),
  description: get_attribute(top_lines, "DESCRIPTION"),
  author: get_attribute(top_lines, "AUTHOR", null_value: "No author"),
  creator: get_attribute(top_lines, "CREATOR", null_value: "No creator"),
  publisher: get_attribute(top_lines, "PUBLISHER", null_value: "No publisher"),
}

pp attrs if DEBUG_MODE

if attrs[:url].include?("foreignaffairs.com")
  attrs[:publisher] = "Foreign Affairs"
end

entry = <<~EOS
*** READ #{attrs[:title]}
    :PROPERTIES:
    :TITLE: #{attrs[:title]}
    :URL: #{attrs[:url]}
    :FILE: ~/bookmarks/#{path.basename}
    :DATE:
    :ARCHIVAL_DATE: #{attrs[:date]}
    :TAGS:
    :DESCRIPTION: #{attrs[:description]}
    :LANGUAGE: #{attrs[:lang]}
    :AUTHOR: #{attrs[:author]}
    :CREATOR: #{attrs[:creator]}
    :PUBLISHER: #{attrs[:publisher]}
EOS

if attrs[:url].include?("https://x.com/") || attrs[:url].include?("https://twitter.com/")
entry << <<EOS
    :KIND: tweet
EOS
end

entry << <<EOS
    :END:
    [[~/bookmarks/#{path.basename}]]
EOS

puts entry

Tempfile.open do |tempfile|
  tempfile.write(entry)
  tempfile.flush

  system("nvim #{tempfile.path}")

  tempfile.rewind
  entry = tempfile.read
end

confirmation = STDIN.gets.chomp

unless ["yes", "y"].include?(confirmation)
  puts "nothing done"
  exit
end

FileUtils.mv(path, File.expand_path("~/bookmarks/#{path.basename}")) unless DEBUG_MODE
puts "= File moved"

bookmarks_file = File.open(File.expand_path("~/notes/bookmarks.org"), "a") do |f|
  f.puts entry
end
